<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Kiểm tra MDM Macbook Online - Kiểm tra tình trạng quản lý thiết bị Apple miễn phí</title>
    <meta name="description" content="Công cụ kiểm tra MDM Macbook online miễn phí. Kiểm tra tình trạng quản lý thiết bì Apple, Activation Lock, Find My iPhone chính xác 100%. Hỗ trợ tất cả dòng MacBook, iMac, Mac mini.">
    <meta name="keywords" content="kiểm tra MDM, MDM checker, macbook mdm, activation lock, find my iphone, apple device management, kiểm tra macbook, serial number check">
    <meta name="author" content="MDM Checker Tool">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mdmchecker.com/">
    <meta property="og:title" content="Kiểm tra MDM Macbook Online - Công cụ kiểm tra Apple Device miễn phí">
    <meta property="og:description" content="Kiểm tra tình trạng MDM, Activation Lock của Macbook và thiết bị Apple. Kết quả chính xác, nhanh chóng và miễn phí.">
    <meta property="og:image" content="https://mdmchecker.com/images/og-image.jpg">
    <meta property="og:locale" content="vi_VN">
    <meta property="og:site_name" content="MDM Checker">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://mdmchecker.com/">
    <meta property="twitter:title" content="Kiểm tra MDM Macbook Online - Miễn phí">
    <meta property="twitter:description" content="Công cụ kiểm tra MDM, Activation Lock cho Macbook và thiết bị Apple. Nhanh chóng, chính xác, miễn phí.">
    <meta property="twitter:image" content="https://mdmchecker.com/images/twitter-image.jpg">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mdmchecker.com/">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://mdmchecker.minhnha93.workers.dev">
    <link rel="preconnect" href="https://qr.sepay.vn">
    
    <!-- Structured Data - JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "MDM Checker - Kiểm tra MDM Macbook",
        "description": "Công cụ kiểm tra tình trạng MDM, Activation Lock của Macbook và thiết bị Apple online miễn phí",
        "url": "https://mdmchecker.com",
        "applicationCategory": "UtilitiesApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "VND",
            "description": "Kiểm tra cơ bản miễn phí"
        },
        "provider": {
            "@type": "Organization",
            "name": "MDM Checker",
            "url": "https://mdmchecker.com"
        },
        "featureList": [
            "Kiểm tra MDM Status",
            "Kiểm tra Activation Lock", 
            "Kiểm tra Find My iPhone",
            "Thông tin thiết bị Apple",
            "Hỗ trợ tất cả dòng MacBook"
        ]
    }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; border-radius: 12px; margin: 10px; }
            h1 { font-size: 24px; margin-bottom: 6px; }
            .subtitle { font-size: 14px; margin-bottom: 25px; }
            .logo { width: 50px; height: 50px; font-size: 20px; margin-bottom: 15px; }
        }

        @media (max-width: 480px) {
            .container { padding: 15px; margin: 5px; }
            h1 { font-size: 20px; margin-bottom: 4px; }
            .subtitle { font-size: 12px; margin-bottom: 20px; }
            .logo { width: 40px; height: 40px; font-size: 18px; margin-bottom: 10px; }
            input, select { padding: 12px; font-size: 16px; }
            .btn { padding: 12px; font-size: 14px; margin-top: 8px; }
            .input-group { margin-bottom: 15px; }
            label { margin-bottom: 6px; font-size: 14px; }
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #007AFF, #5856D6);
            border-radius: 12px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        h1 {
            color: #1d1d1f;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .subtitle {
            color: #86868b;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .step {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1d1d1f;
        }

        input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s;
            background: #fafafa;
        }

        input:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
        }

        .service-option {
            background: white;
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .service-option:hover {
            border-color: #007AFF;
            background: #f8f9ff;
        }

        .service-option.selected {
            border-color: #007AFF;
            background: #f8f9ff;
        }

        .service-option input[type="radio"] {
            margin-right: 12px;
            width: auto;
            padding: 0;
        }

        .service-title {
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .service-price {
            font-size: 18px;
            font-weight: bold;
        }

        .price-free {
            color: #28a745;
        }

        .price-paid {
            color: #007AFF;
        }

        .service-desc {
            font-size: 14px;
            color: #86868b;
            margin-top: 4px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #007AFF, #5856D6);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,122,255,0.3);
        }

        .btn-secondary {
            background: #f2f2f7;
            color: #1d1d1f;
            border: 2px solid #e5e5e7;
        }

        .btn-secondary:hover {
            background: #e5e5ea;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .qr-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .qr-code {
            width: 250px;
            height: 250px;
            background: white;
            border-radius: 8px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e5e5e7;
            font-size: 12px;
            color: #86868b;
            overflow: hidden;
        }

        .qr-code img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        @media (max-width: 480px) {
            .qr-code { width: 200px; height: 200px; margin-bottom: 10px; }
            .qr-container { padding: 12px; margin: 15px 0; }
            .price { font-size: 18px; margin-bottom: 8px; }
        }

        .price {
            font-size: 24px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 10px;
        }

        .payment-info {
            color: #86868b;
            font-size: 14px;
            line-height: 1.5;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .result-success {
            background: #d4edda;
        }

        .result-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-info {
            text-align: left;
            margin-top: 15px;
        }

        .status-item {
            padding: 4px 0;
            border-bottom: 1px solid #babbbd;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 500;
            min-width: 100px;
        }

        .status-value {
            color: #86868b;
            text-align: right;
            word-break: break-word;
        }

        @media (max-width: 480px) {
            .status-item { flex-direction: column; align-items: flex-start; gap: 4px; }
            .status-value { text-align: left; font-size: 14px; }
            .result { padding: 15px; }
        }

        .back-btn {
            margin-top: 20px;
        }

        .payment-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 8px;
            font-size: 14px;
        }
        
        @media (max-width: 480px) {
            .payment-grid {
                gap: 3px;
                text-align: left;
                font-size: 13px;
            }
            
            .payment-grid > div:nth-child(even) {
                margin-bottom: 8px;
                padding-left: 8px;
            }
        }

        /* Styles cho toggle */
        .toggle-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .toggle-btn {
            background: #f8f9ff;
            border: 2px solid #007AFF;
            color: #007AFF;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .toggle-btn:hover {
            background: #007AFF;
            color: white;
        }

        .toggle-btn.active {
            background: #007AFF;
            color: white;
        }

        /* Styles cho phần mã thanh toán */
        .payment-code-section {
            background: #f8f9ff;
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .payment-code-section.show {
            display: block;
        }

        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
                max-height: 0;
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
                max-height: 200px;
            }
        }

        .payment-code-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
            color: #007AFF;
            font-size: 14px;
        }

        .payment-code-description {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .divider {
            position: relative;
            text-align: center;
            margin: 20px 0;
            color: #86868b;
            font-size: 14px;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e5e7;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            position: relative;
        }

        .device-thumbnail {
            width: 200px;
            height: 120px;
            margin: 0 auto 20px;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .device-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .device-thumbnail.placeholder {
            color: #86868b;
            font-size: 14px;
            text-align: center;
            padding: 10px;
        }

        /* SEO Content Section */
        .seo-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            font-size: 14px;
            line-height: 1.6;
            color: #1d1d1f;
        }

        .seo-content h2 {
            font-size: 18px;
            color: #007AFF;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .seo-content h3 {
            font-size: 16px;
            color: #1d1d1f;
            margin: 15px 0 10px 0;
            font-weight: 600;
        }

        .seo-content p {
            margin-bottom: 12px;
        }

        .seo-content ul {
            margin: 10px 0 10px 20px;
        }

        .seo-content li {
            margin-bottom: 5px;
        }

        @media (max-width: 480px) {
            .seo-content {
                padding: 15px;
                margin-top: 20px;
                font-size: 13px;
            }
            
            .seo-content h2 {
                font-size: 16px;
            }
            
            .seo-content h3 {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <svg width="48" height="60" viewBox="0 0 24 30" fill="white" style="margin-top: 5px;" aria-hidden="true">
                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
            </svg>
        </div>
        <h1>Kiểm tra MDM Macbook</h1>
        <p class="subtitle">Kiểm tra tình trạng quản lý thiết bị của Macbook</p>

        <!-- Bước 1: Chọn loại dịch vụ và nhập Serial Number -->
        <div id="step1" class="step active">
            <!-- Toggle cho mã thanh toán -->
            <div class="toggle-section">
                <button type="button" class="toggle-btn" id="togglePaymentCode" onclick="togglePaymentCodeSection()" aria-label="Hiển thị/ẩn phần nhập mã thanh toán">
                    💳 Đã có mã thanh toán?
                </button>
            </div>
            <!-- Phần mã thanh toán có sẵn -->
            <div class="payment-code-section" id="paymentCodeSection">
                <div class="payment-code-header">
                    💳 Nhập mã thanh toán có sẵn
                </div>
                <div class="payment-code-description">
                    Nếu bạn đã thanh toán trước đó và có mã giao dịch, nhập vào đây.
                </div>
                <input 
                    type="text" 
                    id="paymentCodeInput" 
                    placeholder="Ví dụ: MDM12345678ABCD"
                    maxlength="16"
                    style="margin-bottom: 0;"
                    aria-label="Mã thanh toán"
                >
            </div>

            <div class="divider">
                <span>Chọn dịch vụ</span>
            </div>

            <div class="input-group">
            </div>

            <div class="input-group">
                <label for="serialNumber">Số Serial Number *</label>
                <input 
                    type="text" 
                    id="serialNumber" 
                    placeholder="Ví dụ: C02Z41234567"
                    maxlength="20"
                    required
                    aria-describedby="serialHelp"
                >
                <small id="serialHelp" style="color: #86868b; font-size: 12px; margin-top: 4px; display: block;">
                    Tìm Serial Number ở: Apple Menu > About This Mac hoặc dưới đế máy
                </small>
                <div id="serialWarning" class="warning-message" style="display: none; color: #dc3545; font-size: 14px; margin-top: 8px; padding: 8px; background: #f8d7da; border-radius: 6px; border-left: 4px solid #dc3545;">
                    ⚠️ Vui lòng nhập số Serial Number
                </div>
            </div>
            <button class="btn btn-primary" onclick="checkSerial()" aria-label="Bắt đầu kiểm tra tình trạng MDM">
                Kiểm tra tình trạng
            </button>
        </div>

        <!-- Bước 2: Hiển thị QR thanh toán -->
        <div id="step2" class="step">
            <h2 style="margin-bottom: 20px; color: #1d1d1f;">Thanh toán dịch vụ</h2>
            
            <div class="qr-container">
                <div class="qr-code" id="qrCode" role="img" aria-label="Mã QR thanh toán">
                    QR Code sẽ hiển thị ở đây
                </div>
                <div class="price" id="paymentPrice">25,000 VNĐ</div>
                <div class="payment-info">
                    Quét mã QR để thanh toán<br>
                    Sau khi thanh toán, nhấn nút "Đã thanh toán"
                </div>
            </div>

            <button class="btn btn-primary" onclick="confirmPayment()" aria-label="Xác nhận đã thanh toán">
                ✓ Đã thanh toán
            </button>
            <button class="btn btn-secondary" onclick="goBack(1)" aria-label="Quay lại bước trước">
                ← Quay lại
            </button>
        </div>

        <!-- Bước 3: Đang xử lý -->
        <div id="step3" class="step">
            <h2 style="margin-bottom: 20px; color: #1d1d1f;">Đang kiểm tra...</h2>
            
            <div style="padding: 40px 0;" role="status" aria-live="polite">
                <div class="loading" aria-hidden="true"></div>
                <p id="loadingText">Đang kết nối với server Apple để kiểm tra tình trạng...</p>
                <p style="color: #86868b; font-size: 14px; margin-top: 10px;">
                    Quá trình này có thể mất 10-30 giây
                </p>
            </div>
        </div>

        <!-- Bước 4: Hiển thị kết quả -->
        <div id="step4" class="step">
            <h2 style="margin-bottom: 20px; color: #1d1d1f;">Kết quả kiểm tra</h2>
            
            <div id="resultContainer" class="result" role="region" aria-label="Kết quả kiểm tra MDM">
                <!-- Kết quả sẽ được hiển thị ở đây -->
            </div>

            <button class="btn btn-primary back-btn" onclick="startOver()" aria-label="Kiểm tra thiết bị khác">
                Kiểm tra thiết bị khác
            </button>
            
            <!-- Nút quay lại khi có lỗi để tái sử dụng mã -->
            <button class="btn btn-secondary back-btn" id="retryBtn" onclick="retryWithSameCode()" style="display: none;" aria-label="Thử lại với mã thanh toán hiện tại">
                ↻ Thử lại với mã cũ
            </button>
        </div>

        <!-- SEO Content Section -->
        <section class="seo-content">
            <h2>Kiểm tra MDM Macbook - Công cụ chuyên nghiệp</h2>
            <p>
                <strong>MDM Checker</strong> là công cụ kiểm tra tình trạng quản lý thiết bị (Mobile Device Management) 
                cho các sản phẩm Apple như MacBook, iMac, Mac mini một cách nhanh chóng và chính xác.
            </p>

            <h3>🔍 Những gì chúng tôi kiểm tra:</h3>
            <ul>
                <li><strong>MDM Status</strong> - Tình trạng quản lý thiết bị từ tổ chức</li>
                <li><strong>Activation Lock</strong> - Khóa kích hoạt Find My</li>
                <li><strong>Find My iPhone/Mac</strong> - Tính năng tìm kiếm thiết bị</li>
                <li><strong>Warranty Status</strong> - Tình trạng bảo hành Apple</li>
                <li><strong>Device Information</strong> - Thông tin chi tiết về máy</li>
            </ul>

            <h3>✅ Tại sao chọn chúng tôi:</h3>
            <ul>
                <li>✓ Kết quả chính xác 100% từ server Apple</li>
                <li>✓ Hỗ trợ tất cả dòng MacBook, iMac, Mac mini</li>
                <li>✓ Giao diện thân thiện, dễ sử dụng</li>
                <li>✓ Bảo mật thông tin tuyệt đối</li>
                <li>✓ Hỗ trợ tiếng Việt</li>
                <li>✓ Kiểm tra cơ bản miễn phí</li>
            </ul>

            <h3>📱 Hướng dẫn tìm Serial Number:</h3>
            <p>
                <strong>Cách 1:</strong> Apple Menu → About This Mac → Serial Number<br>
                <strong>Cách 2:</strong> System Settings → General → About<br>
                <strong>Cách 3:</strong> Kiểm tra dưới đế máy hoặc trong hộp sản phẩm
            </p>

            <p>
                Công cụ kiểm tra MDM của chúng tôi đặc biệt hữu ích khi bạn cần mua MacBook cũ, 
                kiểm tra thiết bị công ty, hoặc xác minh tình trạng khóa kích hoạt trước khi giao dịch.
            </p>
        </section>

        <!-- Contact Section -->
        <section class="contact-section">
            <div style="background: #f8f9ff; border: 2px solid #007AFF; border-radius: 12px; padding: 16px; margin: 20px 0; text-align: center;">
                <h3 style="color: #007AFF; margin-bottom: 10px; font-size: 16px;">📞 Hỗ trợ & Liên hệ</h3>
                <p style="color: #1d1d1f; margin-bottom: 12px; font-size: 14px;">
                    Cần hỗ trợ hoặc có câu hỏi? Liên hệ với chúng tôi:
                </p>
                <a href="https://www.facebook.com/thien.thu.92904" target="_blank" rel="noopener noreferrer" 
                   style="display: inline-flex; align-items: center; gap: 8px; background: #1877f2; color: white; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.2s;" 
                   onmouseover="this.style.background='#166fe5'" onmouseout="this.style.background='#1877f2'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                    Liên hệ Facebook
                </a>
            </div>
        </section>
    </div>

    <script>
        let currentStep = 1;
        let currentSerial = '';
        let currentTransCode = '';
        let selectedService = null;
        let products = {};
        let hasError = false; // Biến để theo dõi trạng thái lỗi

        // Load products từ API khi trang load
        function loadProducts() {
            fetch('https://mdmchecker.minhnha93.workers.dev/api/products', {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json',
                }
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Failed to load products');
                }
                return response.json();
            })
            .then(function(data) {
                products = data;
                updateServiceOptions();
            })
            .catch(function(error) {
                console.error('Error loading products:', error);
                // Không hiển thị gì nếu lỗi API
                document.querySelector('.input-group').innerHTML = '<label>Chọn loại kiểm tra</label><p style="color: #dc3545; padding: 20px; text-align: center;">Không thể tải danh sách dịch vụ. Vui lòng thử lại sau.</p>';
            });
        }

        function updateServiceOptions() {
            var serviceContainer = document.querySelector('.input-group');
            var serviceOptionsHTML = '<label>Chọn loại kiểm tra</label>';
            
            for (var serviceId in products) {
                var product = products[serviceId];
                var priceText = product.price === 0 ? 'Miễn phí' : formatPrice(product.price) + ' VNĐ';
                var priceClass = product.price === 0 ? 'price-free' : 'price-paid';
                
                serviceOptionsHTML += '<div class="service-option" onclick="selectService(' + serviceId + ')"><input type="radio" name="serviceType" value="' + serviceId + '" id="service' + serviceId + '"><label for="service' + serviceId + '" style="margin: 0; cursor: pointer;"><div class="service-title">' + product.name + '</div><div class="service-price ' + priceClass + '">' + priceText + '</div></label></div>';
            }
            
            serviceContainer.innerHTML = serviceOptionsHTML;
        }

        function showWarning(message, type) {
            // var warningElement = document.getElementById('serialWarning');
            // warningElement.textContent = '⚠️ ' + message;
            // warningElement.style.display = 'block';
            
            // // Tự động ẩn sau 5 giây
            // setTimeout(function() {
            //     warningElement.style.display = 'none';
            // }, 5000);
        }

        function hideWarning() {
            // document.getElementById('serialWarning').style.display = 'none';
        }

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            currentStep = step;
        }

        function selectService(serviceValue) {
            selectedService = serviceValue;
            
            document.querySelectorAll('.service-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const selectedOption = document.querySelector('input[value="' + serviceValue + '"]').closest('.service-option');
            selectedOption.classList.add('selected');
            
            document.getElementById('service' + serviceValue).checked = true;
            updatePaymentStep();
        }

        function togglePaymentCodeSection() {
            const section = document.getElementById('paymentCodeSection');
            const toggle = document.getElementById('togglePaymentCode');
            
            if (section.classList.contains('show')) {
                // Ẩn section
                section.classList.remove('show');
                toggle.classList.remove('active');
                toggle.innerHTML = '💳 Đã có mã thanh toán?';
                // Clear input khi ẩn
                document.getElementById('paymentCodeInput').value = '';
            } else {
                // Hiện section
                section.classList.add('show');
                toggle.classList.add('active');
                toggle.innerHTML = '❌ Ẩn mã thanh toán';
                // Focus vào input
                setTimeout(() => {
                    document.getElementById('paymentCodeInput').focus();
                }, 300);
            }
        }

        function checkSerial() {
            const serialInput = document.getElementById('serialNumber');
            const serial = serialInput.value.trim().toUpperCase();
            const paymentCodeInput = document.getElementById('paymentCodeInput');
            const paymentCode = paymentCodeInput.value.trim().toUpperCase();

            // Kiểm tra service được chọn
            if (selectedService === null) {
                return;
            }

            if (!serial) {
                return;
            }

            currentSerial = serial;

            // Kiểm tra nếu có mã thanh toán và service không miễn phí
            if (paymentCode && selectedService !== 0) {
                // Sử dụng mã thanh toán có sẵn
                currentTransCode = paymentCode;
                proceedToCheck();
                return;
            }

            // Logic bình thường
            if (selectedService === 0) {
                proceedToCheck();
            } else {
                generateQRCode();
                showStep(2);
            }
        }

        function proceedToCheck() {
            showStep(3);

            const loadingText = document.getElementById('loadingText');
            if (selectedService === 0) {
                loadingText.textContent = 'Đang kiểm tra thông tin cơ bản của thiết bị...';
            } else {
                loadingText.textContent = 'Đang kết nối với server Apple để kiểm tra tình trạng MDM...';
            }
            
            setTimeout(function() {
                checkDeviceStatus();
            }, 100);
        }

        function generateTransCode() {
            const timestamp = Date.now().toString().slice(-8);
            const random = Math.random().toString(36).substr(2, 4).toUpperCase();
            return 'MDM' + timestamp + random;
        }

        function updatePaymentStep() {
            var currentPrice = products[selectedService].price;
            var serviceName = products[selectedService].name;

            // Cập nhật header
            document.querySelector('#step2 h2').textContent = 'Thanh toán ' + serviceName;
            
            // Cập nhật giá hiển thị
            document.getElementById('paymentPrice').textContent = formatPrice(currentPrice) + ' VNĐ';
        }

        function generateQRCode() {
            const transCode = generateTransCode();
            currentTransCode = transCode;

            var currentPrice = products[selectedService].price
            formatPrice(currentPrice)
            const qrContainer = document.getElementById('qrCode');
            
            qrContainer.innerHTML = '<img src="https://qr.sepay.vn/img?acc=4879617&bank=ACB&amount=' + currentPrice + '&des=' + transCode + '" alt="QR Code thanh toán" onload="this.nextElementSibling.style.display=\'none\';" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\';"><div style="display: none; color: #86868b; padding: 20px; text-align: center;"><p>⚠️ Không thể tải QR Code tự động</p><p style="margin: 10px 0;"><a href="https://qr.sepay.vn/img?acc=4879617&bank=ACB&amount=25000&des=' + transCode + '" target="_blank" style="color: #007AFF; text-decoration: none; font-weight: bold;">👆 Click để xem QR Code</a></p><small>Mã giao dịch: <strong>' + transCode + '</strong></small></div>';

            const paymentInfoDiv = document.querySelector('.payment-info');
            paymentInfoDiv.innerHTML = '<div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;"><div class="payment-grid"><div style="font-weight: 600; color: #1d1d1f;">Ngân hàng:</div><div style="color: #007AFF; font-weight: 600;">ACB (Á Châu Bank)</div><div style="font-weight: 600; color: #1d1d1f;">Số tài khoản:</div><div style="font-family: monospace; font-size: 16px; font-weight: bold; color: #1d1d1f;">4879617</div><div style="font-weight: 600; color: #1d1d1f;">Thụ hưởng:</div><div style="font-weight: bold; color: #1d1d1f;">HO MINH NHA</div><div style="font-weight: 600; color: #1d1d1f;">Số tiền:</div><div style="font-size: 18px; font-weight: bold; color: #28a745;">' + formatPrice(currentPrice) + ' VNĐ</div><div style="font-weight: 600; color: #1d1d1f;">Nội dung CK:</div><div style="background: #007AFF; color: white; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; text-align: center; word-break: break-all;">' + transCode + '</div></div></div><div style="text-align: center; padding: 10px; background: #f0f8ff; border-radius: 8px; margin-top: 10px;"><p style="margin: 5px 0; font-size: 15px; color: #1d1d1f;">📱 Quét QR bằng app ngân hàng</p><p style="margin: 5px 0; font-size: 15px; color: #1d1d1f;">💰 Hoặc chuyển khoản thủ công</p><p style="margin: 8px 0; font-size: 16px; font-weight: 700; color: #dc3545;">⚠️ Nhập chính xác nội dung CK</p></div>';
        }

        function confirmPayment() {
            proceedToCheck();
        }

        function checkDeviceStatus() {
            const resultContainer = document.getElementById('resultContainer');
            
            // Chuẩn bị data cho API
            const apiData = {
                imei: currentSerial,
                service: selectedService,
                transfer_code: selectedService === 0 ? "" : currentTransCode
            };
            
            // Gọi API (với proxy backup nếu CORS lỗi)
            var apiUrl = 'https://mdmchecker.minhnha93.workers.dev/api/check';
            // Uncomment dòng dưới nếu vẫn lỗi CORS:
            // apiUrl = 'https://cors-anywhere.herokuapp.com/' + apiUrl;
            
            fetch(apiUrl, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify(apiData)
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                displayResult(data);
            })
            .catch(function(error) {
                console.error('API Error:', error);
                hasError = true; // Đánh dấu có lỗi
                // Hiển thị lỗi cho user
                resultContainer.className = 'result result-error';
                resultContainer.innerHTML = '<h3 style="margin-bottom: 15px;">❌ Không thể kiểm tra</h3><p>Có lỗi xảy ra khi kết nối với server. Vui lòng thử lại sau.</p><p style="font-size: 12px; color: #86868b; margin-top: 10px;">Nếu bạn đã thanh toán, mã giao dịch của bạn vẫn có hiệu lực.</p>';
                
                // Hiển thị nút retry nếu có mã thanh toán
                if (currentTransCode && selectedService !== 0) {
                    document.getElementById('retryBtn').style.display = 'block';
                }
                
                showStep(4);
            });
        }

        function displayResult(apiResponse) {
            const resultContainer = document.getElementById('resultContainer');
            hasError = false; // Reset trạng thái lỗi khi có kết quả thành công
            
            // Ẩn nút retry khi có kết quả thành công
            document.getElementById('retryBtn').style.display = 'none';
            
            // Kiểm tra status từ API response
            if (apiResponse.success === false) {
                hasError = true; // Đánh dấu có lỗi từ API
                // API trả về lỗi
                resultContainer.className = 'result result-error';
                resultContainer.innerHTML = '<h3 style="margin-bottom: 15px;">❌ Lỗi</h3><p>' + (apiResponse.message || 'Có lỗi xảy ra khi kiểm tra thiết bị') + '</p>';
                
                // Hiển thị nút retry nếu có mã thanh toán
                if (currentTransCode && selectedService !== 0) {
                    document.getElementById('retryBtn').style.display = 'block';
                }
                
                showStep(4);
                return;
            }
            
            // Hiển thị kết quả thành công - SHOW TẤT CẢ DATA TỪ API
            resultContainer.className = 'result result-success';
            
            var resultHTML = '<h3 style="margin-bottom: 15px;">✅ Kết quả kiểm tra</h3>';
            
            // Hiển thị thumbnail nếu có
            if (apiResponse.data && apiResponse.data.thumbnail) {
                resultHTML += '<div class="device-thumbnail"><img src="' + apiResponse.data.thumbnail + '" alt="Hình ảnh thiết bị"></div>'
            }
            
            resultHTML += '<p>Thiết bị với Serial Number <strong>' + currentSerial + '</strong></p>';
            resultHTML += '<div class="status-info">';
            
            // Thêm Serial Number
            resultHTML += '<div class="status-item"><span class="status-label">Serial Number:</span><span class="status-value">' + currentSerial + '</span></div>';
            
            // Hiển thị TẤT CẢ data từ API response (trừ thumbnail đã hiển thị ở trên)
            if (apiResponse.data && typeof apiResponse.data === 'object') {
                for (var key in apiResponse.data) {
                    if (apiResponse.data.hasOwnProperty(key) && key !== 'thumbnail') {
                        var value = apiResponse.data[key];
                        var displayKey = formatKey(key);
                        var displayValue = formatValue(key, value);
                        
                        resultHTML += '<div class="status-item"><span class="status-label">' + displayKey + ':</span><span class="status-value">' + displayValue + '</span></div>';
                    }
                }
            }
            
            resultHTML += '</div>';
            
            resultContainer.innerHTML = resultHTML;
            showStep(4);
        }

        // Helper function để format key cho hiển thị
        function formatKey(key) {
            const keyMap = {
                'modelDesc': 'Mã Máy',
                'model': 'Tên dòng', 
                'activated': 'Đã kích hoạt',
                'warrantyStatus': 'Bảo hành',
                'estPurchaseDate': 'Ngày mua dự kiến',
                'replaced': 'Mất bảo hành',
                'refurbished': 'Hàng tân trang',
                'demoUnit': 'Hàng trưng bày',
                'loaner': 'Hàng nợ trả góp',
                'carrier': 'Nhà mạng',
                'acEligible': 'AppleCare hợp lệ',
                'validPurchaseDate': 'Ngày mua chính thức',
                'registered': 'Đã đăng kí',
                'replacement': 'Được đổi mới',
                'fmiOn': 'Find my iphone mở',
                'isAppleDevice': 'Hàng Apple',
                'simLock': 'Bị khoá Sim',
                'technicalSupport': 'Hỗ trợ kĩ thuật',
                'repairCoverage': 'Hỗ trợ sửa chữa'
            };
            return keyMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Helper function để format value cho hiển thị
        function formatValue(key, value) {
            if (value === null || value === undefined) {
                return '<span style="color: #86868b;">N/A</span>';
            }
            
            // Boolean values - TRUE = ĐỎ, FALSE = XANH LÁ
            if (typeof value === 'boolean') {
                var status, color;
                
                if (value === true) {
                    // TRUE -> màu đỏ
                    if (key === 'activation_lock' || key === 'find_my') {
                        status = 'Bật';
                    } else if (key === 'mdm_status') {
                        status = 'Có quản lý';
                    } else {
                        status = 'Có';
                    }
                    color = '#dc3545'; // đỏ
                } else {
                    // FALSE -> màu xanh lá
                    if (key === 'activation_lock' || key === 'find_my') {
                        status = 'Tắt';
                    } else if (key === 'mdm_status') {
                        status = 'Không có';
                    } else {
                        status = 'Không';
                    }
                    color = '#28a745'; // xanh lá
                }
                
                return '<span style="color: ' + color + '; font-weight: bold;">' + status + '</span>';
            }
            
            // String values
            if (typeof value === 'string') {
                if (key === 'mdm_status') {
                    if (value === 'clean' || value === 'no_mdm') {
                        return '<span style="color: #28a745; font-weight: bold;">Không có</span>';
                    } else {
                        return '<span style="color: #dc3545; font-weight: bold;">Có quản lý</span>';
                    }
                }
                return '<span style="color: #1d1d1f;">' + value + '</span>';
            }
            
            // Number values
            if (typeof value === 'number') {
                return '<span style="color: #1d1d1f;">' + value.toString() + '</span>';
            }
            
            // Object or array values - màu trắng (mặc định)
            if (typeof value === 'object') {
                return '<span style="color: #1d1d1f;">' + JSON.stringify(value) + '</span>';
            }
            
            // Các giá trị khác - màu trắng (mặc định)
            return '<span style="color: #1d1d1f;">' + value.toString() + '</span>';
        }

        function goBack(step) {
            showStep(step);
        }

        function startOver() {
            document.getElementById('serialNumber').value = '';
            document.getElementById('paymentCodeInput').value = '';
            
            // Reset toggle về trạng thái ban đầu
            const section = document.getElementById('paymentCodeSection');
            const toggle = document.getElementById('togglePaymentCode');
            section.classList.remove('show');
            toggle.classList.remove('active');
            toggle.innerHTML = '💳 Đã có mã thanh toán?';
            
            hideWarning(); // Ẩn warning khi start over
            currentSerial = '';
            currentTransCode = '';
            selectedService = null;
            hasError = false; // Reset trạng thái lỗi
            
            // Ẩn nút retry
            document.getElementById('retryBtn').style.display = 'none';
            
            document.querySelectorAll('.service-option').forEach(function(option) {
                option.classList.remove('selected');
            });
            document.querySelectorAll('input[name="serviceType"]').forEach(function(radio) {
                radio.checked = false;
            });
            
            showStep(1);
        }

        // Hàm thử lại với mã thanh toán hiện tại
        function retryWithSameCode() {
            if (currentTransCode && currentSerial && selectedService !== null) {
                // Tự động điền lại thông tin và thử lại
                document.getElementById('serialNumber').value = currentSerial;
                
                // Nếu có mã thanh toán, hiển thị và điền vào
                if (currentTransCode) {
                    const section = document.getElementById('paymentCodeSection');
                    const toggle = document.getElementById('togglePaymentCode');
                    section.classList.add('show');
                    toggle.classList.add('active');
                    toggle.innerHTML = '❌ Ẩn mã thanh toán';
                    document.getElementById('paymentCodeInput').value = currentTransCode;
                }
                
                // Chọn lại service
                if (selectedService !== null) {
                    selectService(selectedService);
                }
                
                hasError = false; // Reset trạng thái lỗi
                showStep(1);
            } else {
                // Fallback - quay về bước 1
                startOver();
            }
        }

        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Events
        document.getElementById('serialNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkSerial();
            }
        });

        document.getElementById('paymentCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkSerial();
            }
        });

        // Ẩn warning khi user bắt đầu nhập
        document.getElementById('serialNumber').addEventListener('input', function() {
            hideWarning();
        });

        // Auto format mã thanh toán thành chữ hoa
        document.getElementById('paymentCodeInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // Auto focus và load products
        window.onload = function() {
            loadProducts();
            document.getElementById('serialNumber').focus();
        };
    </script>
</body>
</html>